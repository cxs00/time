//
//  TimeWebView.swift
//  TIME
//
//  TIME åº”ç”¨ WebView å°è£…
//

import SwiftUI
import WebKit

#if os(iOS)
struct TimeWebView: UIViewRepresentable {
    func makeUIView(context: Context) -> WKWebView {
        // åˆ›å»ºé…ç½® - iOSä¸“ç”¨ä¼˜åŒ–
        let configuration = WKWebViewConfiguration()

        // ğŸ”§ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ç°ä»£APIé…ç½®JavaScriptæƒé™
        let preferences = WKWebpagePreferences()
        preferences.allowsContentJavaScript = true
        configuration.defaultWebpagePreferences = preferences

        // å…è®¸æœ¬åœ°æ–‡ä»¶è®¿é—®ï¼ˆiOSå…³é”®é…ç½®ï¼‰
        configuration.setValue(true, forKey: "allowUniversalAccessFromFileURLs")
        configuration.preferences.setValue(true, forKey: "allowFileAccessFromFileURLs")

        // å…è®¸å†…è”åª’ä½“æ’­æ”¾
        configuration.allowsInlineMediaPlayback = true
        configuration.mediaTypesRequiringUserActionForPlayback = []

        // æ¸…ç†ç¼“å­˜ï¼Œé¿å…æ—§ç‰ˆæœ¬èµ„æºé€ æˆé»‘å±/æ—§ç•Œé¢
        let dataStore = WKWebsiteDataStore.default()
        let types: Set<String> = [WKWebsiteDataTypeDiskCache, WKWebsiteDataTypeMemoryCache]
        dataStore.removeData(ofTypes: types, modifiedSince: Date(timeIntervalSince1970: 0)) {
            print("ğŸ§¹ iOS: å·²æ¸…ç†WKWebViewç¼“å­˜")
        }

        // åˆ›å»ºWebView
        let webView = WKWebView(frame: .zero, configuration: configuration)
        webView.scrollView.isScrollEnabled = true
        webView.scrollView.bounces = true

        // å¯ç”¨å¼€å‘è€…å·¥å…·ä¾¿äºè°ƒè¯•
        if #available(iOS 16.4, *) {
            webView.isInspectable = true
        }

        // ğŸ”§ å…³é”®ä¿®å¤ï¼šä½¿ç”¨å†…è”åŒ–æ–¹æ¡ˆè§£å†³ iOS åŒæºç­–ç•¥é—®é¢˜
        if let urlInWeb = Bundle.main.url(forResource: "activity-tracker", withExtension: "html", subdirectory: "Web") {
            let webDirectory = urlInWeb.deletingLastPathComponent()

            // è¯»å– HTML å¹¶å†…è”æ‰€æœ‰æœ¬åœ°èµ„æº
            if var html = try? String(contentsOf: urlInWeb) {
                print("ğŸ“± iOS å†…è”åŒ–å¤„ç†å¼€å§‹...")

                // 1. å†…è”æœ¬åœ° JS æ–‡ä»¶ï¼ˆä¸åŒ…å« adsense.js - AdSense æ”¿ç­–è¦æ±‚ï¼‰
                let jsFiles = ["storage.js", "notification.js", "ai-classifier.js",
                              "activity-tracker.js", "project-manager.js",
                              "diary-memo.js", "statistics.js", "advanced-charts.js",
                              "app-main.js", "pwa-register.js"]

                var inlinedCount = 0
                for jsFile in jsFiles {
                    let jsURL = webDirectory.appendingPathComponent("js").appendingPathComponent(jsFile)
                    if let jsContent = try? String(contentsOf: jsURL) {
                        html = html.replacingOccurrences(
                            of: "<script src=\"\(jsFile)\"></script>",
                            with: "<script>/* \(jsFile) */\n\(jsContent)\n</script>"
                        )
                        inlinedCount += 1
                        print("  âœ… å†…è”: \(jsFile)")
                    }
                }

                // 2. å†…è” CSS
                let cssURL = webDirectory.appendingPathComponent("css").appendingPathComponent("activity-tracker.css")
                if let cssContent = try? String(contentsOf: cssURL) {
                    html = html.replacingOccurrences(
                        of: "<link rel=\"stylesheet\" href=\"activity-tracker.css\">",
                        with: "<style>/* activity-tracker.css */\n\(cssContent)\n</style>"
                    )
                    print("  âœ… å†…è”: activity-tracker.css")
                }

                // 3. æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
                let loadingIndicator = """
                <div id="app-loading" style="position:fixed;top:0;left:0;right:0;bottom:0;
                     background:linear-gradient(135deg,#667eea,#764ba2);z-index:99999;
                     display:flex;align-items:center;justify-content:center;">
                    <div style="text-align:center;color:white;">
                        <h1 style="font-size:48px;margin-bottom:20px;">â³</h1>
                        <h2>Activity Tracker</h2>
                        <p style="opacity:0.8;">æ­£åœ¨åŠ è½½...</p>
                    </div>
                </div>
                <script>
                    window.addEventListener('load', function() {
                        setTimeout(function() {
                            var loading = document.getElementById('app-loading');
                            if (loading) loading.remove();
                        }, 300);
                    });
                </script>
                """
                html = html.replacingOccurrences(
                    of: "<body>",
                    with: "<body>\(loadingIndicator)"
                )

                print("ğŸ“± å†…è”åŒ–å®Œæˆ:")
                print("  - JS æ–‡ä»¶: \(inlinedCount) ä¸ª")
                print("  - HTML å¤§å°: \(html.count) bytes")
                print("  - åŠ è½½æ–¹å¼: loadHTMLString")

                // 4. ä½¿ç”¨ loadHTMLStringï¼ˆå…³é”®ï¼ï¼‰
                webView.loadHTMLString(html, baseURL: webDirectory)

                // 5. éªŒè¯ JavaScript æ‰§è¡Œ
                DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
                    webView.evaluateJavaScript("typeof window.AppMain") { result, error in
                        if let result = result as? String, result == "undefined" {
                            print("âŒ JavaScript æœªæ­£å¸¸æ‰§è¡Œ")
                        } else {
                            print("âœ… JavaScript æ‰§è¡Œæ­£å¸¸")
                        }
                    }
                }
            } else {
                // é™çº§ï¼šç›´æ¥åŠ è½½æ–‡ä»¶
                print("âš ï¸ æ— æ³•è¯»å– HTMLï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ")
                webView.loadFileURL(urlInWeb, allowingReadAccessTo: webDirectory)
            }
        } else if let htmlPath = Bundle.main.path(forResource: "activity-tracker", ofType: "html") {
            // å…œåº•ï¼šä»æ ¹ç›®å½•åŠ è½½
            let fileURL = URL(fileURLWithPath: htmlPath)
            let webDirectory = fileURL.deletingLastPathComponent()
            print("âš ï¸ ä½¿ç”¨æ ¹ç›®å½•åŠ è½½ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰")
            webView.loadFileURL(fileURL, allowingReadAccessTo: webDirectory)
        } else {
            print("âŒ æœªæ‰¾åˆ°activity-tracker.htmlæ–‡ä»¶")
            // æ˜¾ç¤ºç®€å•çš„é”™è¯¯é¡µé¢
            let errorHTML = """
            <!DOCTYPE html>
            <html>
            <head>
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        min-height: 100vh;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        text-align: center;
                        padding: 20px;
                    }
                    .container { max-width: 400px; }
                    h1 { font-size: 48px; margin-bottom: 20px; }
                    h2 { font-size: 24px; margin-bottom: 15px; font-weight: 600; }
                    p { font-size: 14px; line-height: 1.6; opacity: 0.9; margin-bottom: 10px; }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>âš ï¸</h1>
                    <h2>èµ„æºåŠ è½½å¤±è´¥</h2>
                    <p>Webèµ„æºæ–‡ä»¶æœªæ‰¾åˆ°</p>
                    <p>è¯·åœ¨Xcodeä¸­ç¡®è®¤Webæ–‡ä»¶å¤¹èµ„æºå·²æ­£ç¡®æ·»åŠ åˆ°é¡¹ç›®</p>
                </div>
            </body>
            </html>
            """
            webView.loadHTMLString(errorHTML, baseURL: nil)
        }

        return webView
    }

    func updateUIView(_ uiView: WKWebView, context: Context) {
    }
}
#elseif os(macOS)
struct TimeWebView: NSViewRepresentable {
    func makeNSView(context: Context) -> WKWebView {
        // åˆ›å»ºé…ç½® - macOSä¸“ç”¨ä¼˜åŒ–
        let configuration = WKWebViewConfiguration()

        // é…ç½®preferences
        let preferences = WKWebpagePreferences()
        preferences.allowsContentJavaScript = true
        configuration.defaultWebpagePreferences = preferences

        // å…è®¸æœ¬åœ°æ–‡ä»¶è®¿é—®ï¼ˆmacOSå…³é”®é…ç½®ï¼‰
        configuration.setValue(true, forKey: "allowUniversalAccessFromFileURLs")
        configuration.preferences.setValue(true, forKey: "allowFileAccessFromFileURLs")

        // åˆ›å»ºWebView
        let webView = WKWebView(frame: .zero, configuration: configuration)

        // æ¸…ç†ç¼“å­˜ï¼Œé¿å…æ—§ç‰ˆæœ¬èµ„æºé€ æˆé»‘å±/æ—§ç•Œé¢
        let dataStore = WKWebsiteDataStore.default()
        let types: Set<String> = [WKWebsiteDataTypeDiskCache, WKWebsiteDataTypeMemoryCache]
        dataStore.removeData(ofTypes: types, modifiedSince: Date(timeIntervalSince1970: 0)) {
            print("ğŸ§¹ macOS: å·²æ¸…ç†WKWebViewç¼“å­˜")
        }

        // macOS Resourcesç›®å½•åœ¨Contents/Resources/Webä¸‹ï¼ˆåŠ è½½Activity Trackerï¼‰
        if let htmlURL = Bundle.main.url(forResource: "activity-tracker",
                                         withExtension: "html",
                                         subdirectory: "Web") {
            // ğŸ”§ å…³é”®ä¿®å¤ï¼šæ­£ç¡®è®¾ç½®è®¿é—®æƒé™
            let webDir = htmlURL.deletingLastPathComponent()  // Contents/Resources/Web/
            let resourcesDir = webDir.deletingLastPathComponent()  // Contents/Resources/

            print("ğŸ–¥ï¸ macOS - ä»Webå­ç›®å½•åŠ è½½")
            print("   HTMLè·¯å¾„: \(htmlURL.path)")
            print("   Webç›®å½•: \(webDir.path)")
            print("   è®¿é—®æƒé™æ ¹ç›®å½•: \(resourcesDir.path)")

            // âœ… å…è®¸è®¿é—®æ•´ä¸ª Resources ç›®å½•ï¼ˆåŒ…å« Web/js/, Web/css/ ç­‰å­ç›®å½•ï¼‰
            webView.loadFileURL(htmlURL, allowingReadAccessTo: resourcesDir)
            webView.configuration.preferences.setValue(true, forKey: "developerExtrasEnabled")
            webView.setValue(false, forKey: "drawsBackground")

            // éªŒè¯ JavaScript æ‰§è¡Œ
            DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
                webView.evaluateJavaScript("typeof window.AppMain") { result, error in
                    if let result = result as? String {
                        if result == "undefined" {
                            print("âŒ macOS: JavaScript æœªæ­£å¸¸æ‰§è¡Œ")
                        } else {
                            print("âœ… macOS: JavaScript æ‰§è¡Œæ­£å¸¸ï¼ŒAppMain ç±»å‹: \(result)")
                        }
                    } else if let error = error {
                        print("âš ï¸ macOS: JavaScript æ£€æŸ¥å¤±è´¥: \(error.localizedDescription)")
                    }
                }
            }
        } else {
            print("âŒ macOS: æœªæ‰¾åˆ° Web/activity-tracker.html æ–‡ä»¶")

            // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯é¡µé¢
            let errorHTML = """
            <!DOCTYPE html>
            <html>
            <head>
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        min-height: 100vh;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        text-align: center;
                        padding: 40px;
                    }
                    .container { max-width: 500px; }
                    h1 { font-size: 64px; margin-bottom: 20px; }
                    h2 { font-size: 28px; margin-bottom: 20px; font-weight: 600; }
                    p { font-size: 16px; line-height: 1.8; opacity: 0.95; margin-bottom: 12px; }
                    .code {
                        background: rgba(0,0,0,0.2);
                        padding: 15px;
                        border-radius: 8px;
                        font-family: 'SF Mono', Monaco, monospace;
                        font-size: 14px;
                        margin-top: 20px;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>âš ï¸</h1>
                    <h2>èµ„æºåŠ è½½å¤±è´¥</h2>
                    <p>Webèµ„æºæ–‡ä»¶æœªæ‰¾åˆ°</p>
                    <p>è¯·åœ¨Xcodeä¸­ç¡®è®¤Webæ–‡ä»¶å¤¹å·²æ­£ç¡®æ·»åŠ åˆ°é¡¹ç›®</p>
                    <div class="code">
                        æ£€æŸ¥: Webèµ„æº â†’ Target Membership â†’ âœ“ time
                    </div>
                </div>
            </body>
            </html>
            """
            webView.loadHTMLString(errorHTML, baseURL: nil)
        }

        return webView
    }

    func updateNSView(_ nsView: WKWebView, context: Context) {
    }
}
#endif

#Preview {
    TimeWebView()
}
