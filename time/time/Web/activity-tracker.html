<!DOCTYPE html>
<html lang="zh-CN">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Activity Tracker - 智能活动记录与进度管理">
    <title>Activity Tracker - 智能活动记录</title>

    <!-- 安全头部 -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">

    <!-- 内联关键CSS确保样式生效 -->
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f8f9fa;
        /* iOS安全区域支持 */
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }

      /* 导航栏 */
      .navbar {
        background: #ffffff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        /* iOS安全区域顶部支持 */
        padding-top: max(1rem, env(safe-area-inset-top));
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .nav-brand {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 1rem;
      }

      .brand-icon {
        font-size: 1.5rem;
      }

      .brand-name {
        color: #667eea;
      }

      .nav-links {
        display: flex;
        justify-content: space-around;
        width: 100%;
        gap: 0.5rem;
      }

      .nav-link {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        padding: 0.5rem 0.25rem;
        text-decoration: none;
        color: #666;
        border-radius: 8px;
        flex: 1;
        max-width: 70px;
      }

      .nav-link.active {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }

      .nav-icon {
        font-size: 1.5rem;
      }

      .nav-text {
        font-size: 0.7rem;
        white-space: nowrap;
      }

      /* 页面切换 */
      .page {
        display: none;
        padding: 1rem;
      }

      .page.active {
        display: block;
      }

      /* 卡片 */
      .card {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .card-title {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      /* ==================== 模态框样式（内联确保生效） ==================== */
      .modal {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background: rgba(0, 0, 0, 0.5) !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        z-index: 10001 !important; /* 高于调试面板(10000) */
        animation: modalFadeIn 0.3s ease;
      }

      @keyframes modalFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .modal-content {
        background: white !important;
        border-radius: 16px !important;
        padding: 2rem !important;
        max-width: 500px !important;
        width: 90% !important;
        max-height: 80vh !important;
        overflow-y: auto !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
        animation: modalSlideUp 0.3s ease;
        position: relative !important;
        z-index: 10002 !important;
      }

      @keyframes modalSlideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-content h3 {
        margin: 0 0 1.5rem 0 !important;
        color: #333 !important;
        font-size: 1.5rem !important;
        background: linear-gradient(135deg, #667eea, #764ba2) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
      }

      .form-group {
        margin-bottom: 1.5rem !important;
      }

      .form-group label {
        display: block !important;
        margin-bottom: 0.5rem !important;
        color: #555 !important;
        font-weight: 600 !important;
        font-size: 0.9rem !important;
      }

      .form-group input[type="text"],
      .form-group input[type="date"],
      .form-group select,
      .form-group textarea {
        width: 100% !important;
        padding: 0.75rem !important;
        border: 2px solid #e0e0e0 !important;
        border-radius: 8px !important;
        font-size: 1rem !important;
        transition: all 0.3s !important;
        font-family: inherit !important;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none !important;
        border-color: #667eea !important;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
      }

      .form-group textarea {
        min-height: 100px !important;
        resize: vertical !important;
      }

      .form-group input[type="range"] {
        width: calc(100% - 60px) !important;
        margin-right: 10px !important;
      }

      .form-actions {
        display: flex !important;
        gap: 1rem !important;
        justify-content: flex-end !important;
        margin-top: 2rem !important;
      }

      .form-actions button {
        padding: 0.75rem 1.5rem !important;
        border: none !important;
        border-radius: 8px !important;
        font-size: 1rem !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        transition: all 0.3s !important;
      }

      .btn-primary,
      .form-actions button[type="submit"] {
        background: linear-gradient(135deg, #667eea, #764ba2) !important;
        color: white !important;
      }

      .btn-secondary,
      .form-actions button[type="button"] {
        background: #f0f0f0 !important;
        color: #666 !important;
      }

      /* 移动端优化 */
      @media (max-width: 768px) {
        .modal-content {
          width: 95% !important;
          padding: 1.5rem !important;
          max-height: 90vh !important;
        }

        .modal-content h3 {
          font-size: 1.25rem !important;
        }

        .form-actions {
          flex-direction: column !important;
        }

        .form-actions button {
          width: 100% !important;
        }
      }
    </style>

    <link rel="stylesheet" href="css/activity-tracker.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  </head>

  <body>
    <!-- 导航栏 -->
    <nav class="navbar">
      <div class="nav-brand">
        <span class="brand-icon">📊</span>
        <span class="brand-name">Activity Tracker</span>
      </div>
      <div class="nav-links">
        <a href="#home" class="nav-link active" data-page="home">
          <span class="nav-icon">🏠</span>
          <span class="nav-text">记录</span>
        </a>
        <a href="#projects" class="nav-link" data-page="projects">
          <span class="nav-icon">🎯</span>
          <span class="nav-text">项目</span>
        </a>
        <a href="#stats" class="nav-link" data-page="stats">
          <span class="nav-icon">📈</span>
          <span class="nav-text">统计</span>
        </a>
        <a href="#diary" class="nav-link" data-page="diary">
          <span class="nav-icon">📖</span>
          <span class="nav-text">日记</span>
        </a>
        <a href="#settings" class="nav-link" data-page="settings">
          <span class="nav-icon">⚙️</span>
          <span class="nav-text">设置</span>
        </a>
      </div>
    </nav>

    <!-- 主页面 - 活动记录 -->
    <main id="home" class="page active">
      <div class="container">
        <!-- 当前活动状态 -->
        <section class="current-activity-card card">
          <h3 class="card-title">📊 当前活动</h3>
          <div id="currentActivity" class="activity-display">
            <div class="activity-info">
              <span class="activity-name">暂无活动</span>
              <span class="activity-duration">00:00:00</span>
            </div>
            <div class="activity-controls">
              <button id="pauseActivity" class="btn btn-pause" disabled>⏸️ 暂停</button>
              <button id="endActivity" class="btn btn-end" disabled>⏹️ 结束</button>
            </div>
          </div>
        </section>

        <!-- 快速记录 -->
        <section class="quick-record-card card">
          <h3 class="card-title">⚡ 快速记录</h3>
          <div class="record-form">
            <div class="input-group">
              <input type="text" id="activityInput" placeholder="现在在做什么？" class="activity-input">
              <div class="smart-suggestions" id="smartSuggestions"></div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>分类：</label>
                <select id="categorySelect" class="select-input">
                  <option value="">智能推荐</option>
                  <option value="工作">💼 工作</option>
                  <option value="学习">📚 学习</option>
                  <option value="运动">🏃 运动</option>
                  <option value="娱乐">🎮 娱乐</option>
                  <option value="生活">🏠 生活</option>
                </select>
                <button id="addCustomCategory" class="btn btn-secondary">+ 自定义</button>
              </div>

              <div class="form-group">
                <label>关联项目：</label>
                <select id="projectSelect" class="select-input">
                  <option value="">自动关联</option>
                </select>
              </div>
            </div>

            <button id="startActivity" class="btn btn-primary btn-start">🚀 开始记录</button>
          </div>
        </section>

        <!-- 今日概览 -->
        <section class="today-overview-card card">
          <h3 class="card-title">📈 今日概览</h3>
          <div class="activity-summary">
            <div class="summary-stats">
              <div class="stat-item">
                <span class="stat-label">总时间</span>
                <span class="stat-value" id="totalTime">0小时</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">活动数</span>
                <span class="stat-value" id="activityCount">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">效率</span>
                <span class="stat-value" id="efficiency">0%</span>
              </div>
            </div>
            <!-- 今日活动分布饼图 -->
            <div class="activity-distribution">
              <h4 class="distribution-title">📊 今日活动分布</h4>
              <div class="chart-container-small">
                <div id="todayDistributionChart" style="width: 100%; height: 200px;"></div>
              </div>
            </div>
            <div class="activity-timeline" id="activityTimeline"></div>
          </div>
        </section>
      </div>
    </main>

    <!-- 项目页面 -->
    <main id="projects" class="page">
      <div class="container">
        <div class="page-header">
          <h2>🎯 项目进度</h2>
          <button id="createProject" class="btn btn-primary">+ 新建项目</button>
        </div>
        <div class="projects-grid" id="projectsGrid">
          <p class="no-projects">还没有创建任何项目</p>
        </div>
      </div>
    </main>

    <!-- 统计页面 -->
    <main id="stats" class="page">
      <div class="container">
        <section class="time-selector-card card">
          <h3 class="card-title">📊 活动统计</h3>
          <div class="time-range-selector">
            <select id="timeRange" class="select-input">
              <option value="today">今天</option>
              <option value="week">本周</option>
              <option value="month">本月</option>
              <option value="quarter">本季度</option>
              <option value="year">今年</option>
              <option value="custom">自定义</option>
            </select>
            <input type="date" id="startDate" class="date-input" style="display:none;">
            <input type="date" id="endDate" class="date-input" style="display:none;">
            <button id="applyTimeRange" class="btn btn-primary" style="display:none;">应用</button>
          </div>
        </section>

        <div class="charts-container">
          <section class="chart-card card">
            <h3 class="card-title">📊 活动时间分布</h3>
            <div id="activityPieChart" class="chart"></div>
          </section>

          <section class="chart-card card">
            <h3 class="card-title">📈 时间趋势</h3>
            <div id="trendLineChart" class="chart"></div>
          </section>

          <section class="chart-card card">
            <h3 class="card-title">🔥 活动热力图</h3>
            <div id="activityHeatmap" class="chart"></div>
          </section>
        </div>
      </div>
    </main>

    <!-- 日记页面 -->
    <main id="diary" class="page">
      <div class="container">
        <div class="diary-memo-grid">
          <!-- 日记功能 -->
          <section class="diary-card card">
            <h3 class="card-title">📖 今日日记</h3>
            <div class="diary-editor">
              <div class="diary-header">
                <span class="diary-date" id="diaryDate"></span>
                <div class="mood-selector">
                  <label>心情：</label>
                  <select id="moodSelect" class="select-input">
                    <option value="😊">😊 开心</option>
                    <option value="😐">😐 平静</option>
                    <option value="😔">😔 低落</option>
                    <option value="😤">😤 愤怒</option>
                    <option value="😴">😴 疲惫</option>
                  </select>
                </div>
              </div>
              <textarea id="diaryContent" class="diary-textarea" placeholder="记录今天的心情和想法..."></textarea>
              <div class="diary-actions">
                <button id="saveDiary" class="btn btn-primary">💾 保存</button>
                <button id="aiSuggest" class="btn btn-secondary">🤖 AI建议</button>
              </div>
            </div>
          </section>

          <!-- 历史日记列表 -->
          <section class="diary-history-card card">
            <h3 class="card-title">📚 历史日记</h3>
            <div class="diary-list" id="diaryList">
              <p class="no-diaries">还没有写任何日记</p>
            </div>
          </section>

          <!-- 备忘录功能 -->
          <section class="memo-card card">
            <h3 class="card-title">📌 备忘录</h3>
            <div class="memo-input-group">
              <input type="text" id="memoInput" class="memo-input" placeholder="记录想法或提醒...">
              <button id="addMemo" class="btn btn-primary">+</button>
            </div>
            <div class="memo-list" id="memoList">
              <p class="no-memos">还没有添加任何备忘录</p>
            </div>
          </section>
        </div>
      </div>
    </main>


    <!-- 设置页面 -->
    <main id="settings" class="page">
      <div class="container">
        <section class="settings-card card">
          <h3 class="card-title">⚙️ 设置</h3>
          <div class="settings-content">
            <!-- 主题设置 -->
            <div class="setting-item">
              <label>🎨 界面主题</label>
              <select id="themeSelect" class="select-input" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid #e0e0e0;">
                <option value="default">默认主题</option>
                <option value="starry-night">✨ 星夜</option>
                <option value="water-lilies">💧 睡莲</option>
              </select>
            </div>

            <!-- UI尺寸设置 -->
            <div class="setting-item">
              <label>📐 UI尺寸</label>
              <select id="sizeSelect" class="select-input" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid #e0e0e0;">
                <option value="standard">标准</option>
                <option value="large">大</option>
                <option value="extra-large">超大</option>
              </select>
            </div>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">

            <div class="setting-item">
              <label>数据导出</label>
              <button class="btn btn-secondary" onclick="exportData()">导出数据</button>
            </div>
            <div class="setting-item">
              <label>数据导入</label>
              <button class="btn btn-secondary" onclick="importData()">导入数据</button>
            </div>
            <div class="setting-item">
              <label>清除所有数据</label>
              <button class="btn btn-danger" onclick="clearAllData()">清除数据</button>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Toast通知 -->
    <div class="toast" id="toast">
      <span class="toast-icon">✓</span>
      <span class="toast-message" id="toastMessage"></span>
    </div>

    <!-- 调试面板 -->
    <div id="debugPanel"
      style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.95); color: #00ff00; padding: 10px; font-family: 'Courier New', monospace; font-size: 10px; max-height: 250px; overflow-y: auto; z-index: 10000; border-top: 2px solid #00ff00;">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #00ff00;">
        <div style="font-weight: bold; color: #ffff00;">🐛 调试控制台 (Console Debug Panel)</div>
        <div style="display: flex; gap: 10px;">
          <button onclick="clearDebugLog()"
            style="background: #333; color: #00ff00; border: 1px solid #00ff00; padding: 2px 8px; cursor: pointer; border-radius: 3px; font-size: 10px;">清空</button>
          <button onclick="toggleDebugPanel()"
            style="background: #333; color: #ff0000; border: 1px solid #ff0000; padding: 2px 8px; cursor: pointer; border-radius: 3px; font-size: 10px;">最小化</button>
        </div>
      </div>
      <div id="debugLog" style="line-height: 1.4;">
        <div style="color: #ffff00;">📊 调试面板已启动 - 所有Console日志将显示在这里...</div>
      </div>
    </div>

    <!-- JavaScript -->
    <!-- 调试面板脚本（必须在其他脚本之前加载） -->
    <script>
      // 调试面板功能
      let debugPanelVisible = true;
      let debugLogCount = 0;
      const MAX_LOG_LINES = 100; // 最多保留100行日志

      // 清空调试日志
      function clearDebugLog() {
        const debugLog = document.getElementById('debugLog');
        if (debugLog) {
          debugLog.innerHTML = '<div style="color: #ffff00;">📊 调试日志已清空</div>';
          debugLogCount = 0;
        }
      }

      // 切换调试面板显示/隐藏
      function toggleDebugPanel() {
        const debugPanel = document.getElementById('debugPanel');
        if (debugPanel) {
          debugPanelVisible = !debugPanelVisible;
          if (debugPanelVisible) {
            debugPanel.style.display = 'block';
            debugPanel.style.maxHeight = '250px';
          } else {
            debugPanel.style.display = 'block';
            debugPanel.style.maxHeight = '30px';
            debugPanel.style.overflow = 'hidden';
          }
        }
      }

      // 添加日志到调试面板
      function addDebugLog(message, type = 'log') {
        const debugLog = document.getElementById('debugLog');
        if (!debugLog) return;

        // 限制日志行数
        if (debugLogCount >= MAX_LOG_LINES) {
          const firstLog = debugLog.querySelector('div:first-child');
          if (firstLog) firstLog.remove();
        } else {
          debugLogCount++;
        }

        // 根据日志类型选择颜色
        let color = '#00ff00'; // 默认绿色
        let icon = '•';

        switch (type) {
          case 'log':
            color = '#00ff00';
            icon = '•';
            break;
          case 'info':
            color = '#00ccff';
            icon = 'ℹ';
            break;
          case 'warn':
            color = '#ffaa00';
            icon = '⚠';
            break;
          case 'error':
            color = '#ff0000';
            icon = '✖';
            break;
          case 'success':
            color = '#00ff00';
            icon = '✓';
            break;
        }

        // 格式化消息
        const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
        const logEntry = document.createElement('div');
        logEntry.style.color = color;
        logEntry.style.marginBottom = '2px';
        logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${icon} ${message}`;

        debugLog.appendChild(logEntry);

        // 自动滚动到底部
        debugLog.scrollTop = debugLog.scrollHeight;
      }

      // 拦截console方法
      const originalConsole = {
        log: console.log,
        info: console.info,
        warn: console.warn,
        error: console.error
      };

      // 重写console.log
      console.log = function (...args) {
        originalConsole.log.apply(console, args);
        const message = args.map(arg => {
          if (typeof arg === 'object') {
            try {
              return JSON.stringify(arg, null, 2);
            } catch (e) {
              return String(arg);
            }
          }
          return String(arg);
        }).join(' ');
        addDebugLog(message, 'log');
      };

      // 重写console.info
      console.info = function (...args) {
        originalConsole.info.apply(console, args);
        const message = args.map(arg => String(arg)).join(' ');
        addDebugLog(message, 'info');
      };

      // 重写console.warn
      console.warn = function (...args) {
        originalConsole.warn.apply(console, args);
        const message = args.map(arg => String(arg)).join(' ');
        addDebugLog(message, 'warn');
      };

      // 重写console.error
      console.error = function (...args) {
        originalConsole.error.apply(console, args);
        const message = args.map(arg => String(arg)).join(' ');
        addDebugLog(message, 'error');
      };

      // 捕获全局错误
      window.addEventListener('error', function (event) {
        addDebugLog(`全局错误: ${event.message} (${event.filename}:${event.lineno})`, 'error');
      });

      // 捕获Promise错误
      window.addEventListener('unhandledrejection', function (event) {
        addDebugLog(`Promise错误: ${event.reason}`, 'error');
      });

      console.log('🐛 调试面板已初始化');
    </script>

    <script src="storage.js"></script>
    <script src="notification.js"></script>
    <script src="ai-classifier.js"></script>
    <script src="activity-tracker.js"></script>
    <script src="project-manager.js"></script>
    <script src="diary-memo.js"></script>
    <script src="statistics.js"></script>
    <script src="app-main.js"></script>
    
    <!-- 主题和UI尺寸切换 -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const themeSelect = document.getElementById('themeSelect');
        const sizeSelect = document.getElementById('sizeSelect');
        
        // 加载保存的设置
        const savedTheme = localStorage.getItem('app-theme') || 'default';
        const savedSize = localStorage.getItem('app-size') || 'standard';
        
        if (themeSelect) {
          themeSelect.value = savedTheme;
          applyTheme(savedTheme);
          
          themeSelect.addEventListener('change', function() {
            const theme = this.value;
            applyTheme(theme);
            localStorage.setItem('app-theme', theme);
            showToast('主题已切换');
          });
        }
        
        if (sizeSelect) {
          sizeSelect.value = savedSize;
          applySize(savedSize);
          
          sizeSelect.addEventListener('change', function() {
            const size = this.value;
            applySize(size);
            localStorage.setItem('app-size', size);
            showToast('UI尺寸已更改');
          });
        }

        // 监听DOM变化，确保后续动态渲染的元素也应用尺寸设置
        const mo = new MutationObserver(() => {
          try {
            const currentSize = localStorage.getItem('app-size') || 'standard';
            applySize(currentSize);
          } catch (e) {
            console.warn('MutationObserver applySize error:', e);
          }
        });
        mo.observe(document.body, { childList: true, subtree: true });
      });
      
      function applyTheme(theme) {
        document.body.className = document.body.className.replace(/theme-\S+/g, '');
        if (theme !== 'default') {
          document.body.classList.add('theme-' + theme);
        }
        
        if (theme === 'starry-night') {
          document.body.style.background = 'linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #312e81 100%)';
        } else if (theme === 'water-lilies') {
          document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        } else {
          document.body.style.background = '';
        }
      }
      
      function applySize(size) {
        const sizes = {
          'standard': { input: '48px', button: '48px', font: '16px', padding: '14px 18px', buttonPadding: '14px 26px' },
          'large': { input: '54px', button: '54px', font: '17px', padding: '16px 20px', buttonPadding: '16px 28px' },
          'extra-large': { input: '60px', button: '60px', font: '18px', padding: '18px 22px', buttonPadding: '18px 32px' }
        };
        
        const config = sizes[size] || sizes.standard;
        
        // 直接应用到所有输入框和按钮
        const inputs = document.querySelectorAll('.activity-input, input[type="text"], textarea, select');
        inputs.forEach(el => {
          el.style.minHeight = config.input;
          el.style.fontSize = config.font;
          el.style.padding = config.padding;
        });
        
        const buttons = document.querySelectorAll('.btn, button');
        buttons.forEach(el => {
          if (!el.closest('#debugPanel')) {
            el.style.minHeight = config.button;
            el.style.fontSize = config.font;
            el.style.padding = config.buttonPadding;
            el.style.borderRadius = '10px';
          }
        });
      }

      // 暴露到window，便于其他模块在渲染后主动调用
      window.applySize = applySize;
      window.applyTheme = applyTheme;
    </script>
  </body>

</html>
